<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Link Obfuscator — Browser UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---------- Theme & layout ---------- */
    :root{
      --bg: #ffffff;
      --card: #f6f7f9;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #2563eb;
      --accent-2: #10b981;
      --danger: #ef4444;
      --radius: 10px;
      --glass: rgba(255,255,255,0.6);
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #071024;
        --card: #081227;
        --muted: #98a0b3;
        --text: #e6eef8;
        --accent: #4f9cff;
        --accent-2: #34d399;
        --danger: #ff7b7b;
        --glass: rgba(255,255,255,0.02);
      }
    }

    html,body{
      height:100%;
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg), var(--glass));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding:28px;
      box-sizing:border-box;
    }

    main {
      max-width:760px;
      margin:0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      padding:20px;
      border-radius:14px;
      box-shadow: 0 6px 30px rgba(3,10,27,0.08);
      backdrop-filter: blur(6px);
    }

    h1{
      margin:0 0 8px 0;
      font-size:1.35rem;
      letter-spacing:-0.01em;
    }
    p.lead {
      margin:6px 0 18px 0;
      color:var(--muted);
      font-size:0.95rem;
    }

    /* ---------- Form ---------- */
    form { display:block; gap:12px; }

    label { display:block; margin-top:12px; font-weight:600; font-size:0.95rem; color:var(--text); }
    .hint { color:var(--muted); font-size:0.9rem; margin-top:8px; }

    input[type="url"],
    input[type="number"],
    button,
    .result {
      font-size:1rem;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(10,14,24,0.06);
      background: transparent;
      color:var(--text);
      box-sizing:border-box;
      width:100%;
    }

    input:focus, button:focus, .result:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(37,99,235,0.08);
      border-color: rgba(37,99,235,0.6);
    }

    input[type="url"] {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:8px;
    }

    .row { display:flex; gap:8px; margin-top:8px; }
    .row > * { flex:1; }

    button {
      cursor:pointer;
      border: none;
      background: linear-gradient(180deg, var(--accent), #1e63d6);
      color: white;
      font-weight:600;
      padding:10px 14px;
      border-radius:8px;
      transition: transform .06s ease, box-shadow .06s ease, opacity .12s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    button.secondary {
      background: transparent;
      border: 1px solid rgba(10,14,24,0.06);
      color: var(--text);
      font-weight:600;
    }
    button:active { transform: translateY(1px); }
    button[disabled] { opacity:0.6; cursor:not-allowed; transform:none; }

    /* ---------- Result card ---------- */
    .result {
      margin-top:12px;
      background: var(--card);
      padding:14px;
      border-radius:var(--radius);
      word-break:break-word;
      border: 1px solid rgba(10,14,24,0.04);
      display:none;
    }

    .url-wrap {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
    }

    .url-text {
      flex:1;
      background: rgba(0,0,0,0.00);
      padding:8px 10px;
      border-radius:8px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      color:var(--text);
      border: 1px dashed rgba(10,14,24,0.04);
    }

    .controls {
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .controls button {
      flex:1;
      font-size:0.95rem;
      padding:8px 10px;
    }

    .info {
      margin-top:10px;
      color:var(--muted);
      font-size:0.9rem;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .chip {
      display:inline-flex;
      gap:8px;
      align-items:center;
      background: rgba(0,0,0,0.03);
      padding:6px 8px;
      border-radius:999px;
      font-size:0.85rem;
      color:var(--muted);
    }

    .spinner { width:14px; height:14px; border-radius:50%; border:2px solid rgba(255,255,255,0.25); border-top-color:rgba(255,255,255,0.75); animation:spin .8s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* success / error */
    .info.success { color: var(--accent-2); }
    .info.error { color: var(--danger); }

    /* small screens */
    @media (max-width:520px){
      .row { flex-direction:column; }
      .controls { flex-direction:column; }
    }

    /* tiny utilities */
    .muted { color:var(--muted); font-size:0.92rem; }
    .visually-hidden { position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <main>
    <h1>Link Obfuscator</h1>
    <p class="lead">Create short obfuscated links for sharing. Secrets stay on the worker—this UI never contains them.</p>

    <label for="url">Target URL</label>
    <input id="url" type="url" inputmode="url" placeholder="https://example.com/some/path" aria-describedby="urlHint" />

    <div id="urlHint" class="hint">Include protocol (https://). The worker will validate and sanitize on the server.</div>

    <label for="expiry">Expiry (seconds, optional — default = 30 days)</label>
    <input id="expiry" type="number" min="1" placeholder="2592000" />

    <div class="row" style="margin-top:12px;">
      <button id="gen" aria-live="polite">Create Obfuscated Link</button>
      <button id="pasteCurrent" class="secondary" type="button">Use current page URL</button>
    </div>

    <div id="out" class="result" role="status" aria-live="polite">
      <div><strong>Obfuscated URL</strong></div>

      <div class="url-wrap" style="margin-top:8px;">
        <div id="obf" class="url-text" title=""></div>
      </div>

      <div class="controls">
        <button id="copy" class="secondary" type="button">Copy to clipboard</button>
        <button id="open" class="secondary" type="button">Open link</button>
      </div>

      <div id="info" class="info muted" style="margin-top:10px;"></div>
    </div>
  </main>

  <script>
    // <-- REPLACE THIS with your worker origin (from wrangler publish or dashboard) -->
    const workerOrigin = "https://wild-sun-6d29.fiona-morris698.workers.dev";

    // DOM
    const elUrl = document.getElementById('url');
    const elExpiry = document.getElementById('expiry');
    const btnGen = document.getElementById('gen');
    const btnPaste = document.getElementById('pasteCurrent');
    const out = document.getElementById('out');
    const obf = document.getElementById('obf');
    const btnCopy = document.getElementById('copy');
    const btnOpen = document.getElementById('open');
    const info = document.getElementById('info');

    // Helpers
    function isValidUrl(s) {
      try {
        const url = new URL(s);
        return url.protocol === "http:" || url.protocol === "https:";
      } catch (e) {
        return false;
      }
    }

    function setLoading(loading) {
      btnGen.disabled = loading;
      if (loading) {
        btnGen.innerHTML = 'Creating <span class="spinner" aria-hidden="true"></span>';
      } else {
        btnGen.textContent = 'Create Obfuscated Link';
      }
    }

    function showInfo(text, type = "muted") {
      info.className = "info " + (type === "muted" ? "" : type);
      info.textContent = text;
    }

    btnPaste.addEventListener('click', () => {
      elUrl.value = window.location.href;
      elExpiry.focus();
    });

    btnGen.addEventListener('click', async () => {
      showInfo("", "muted");
      out.style.display = 'none';
      obf.textContent = "";
      obf.title = "";

      const target = elUrl.value.trim();
      const expiryValue = elExpiry.value.trim();

      if (!target) { alert("Enter a URL"); elUrl.focus(); return; }
      if (!isValidUrl(target)) { alert("Enter a valid http/https URL."); elUrl.focus(); return; }

      // client-side sanity limit (server should also enforce)
      const MAX_EXPIRY = 60 * 60 * 24 * 30; // 30 days
      let expiryNum;
      if (expiryValue) {
        expiryNum = Number(expiryValue);
        if (!Number.isFinite(expiryNum) || expiryNum <= 0) {
          alert("Expiry must be a positive number (seconds).");
          elExpiry.focus();
          return;
        }
        if (expiryNum > MAX_EXPIRY) {
          if (!confirm("Expiry is greater than 30 days. Continue?")) return;
        }
      }

      setLoading(true);
      try {
        const body = { url: target };
        if (expiryValue) body.expiry = expiryNum;

        const res = await fetch(workerOrigin + "/encode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
          credentials: 'omit'
        });

        const text = await res.text().catch(() => "");
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (err) {
          showInfo("Unexpected response from worker (not JSON). See console.", "error");
          console.error("Non-JSON response:", text);
          setLoading(false);
          return;
        }

        if (!res.ok) {
          const msg = data && data.error ? data.error : (data.message || JSON.stringify(data));
          showInfo("Worker error: " + msg, "error");
          setLoading(false);
          return;
        }

        let finalUrl = "";
        if (data.obfuscatedUrl) {
          finalUrl = data.obfuscatedUrl;
        } else if (data.token) {
          finalUrl = workerOrigin.replace(/\/$/, '') + "/o/" + encodeURIComponent(data.token);
        } else if (typeof data === "string") {
          finalUrl = data;
        } else {
          finalUrl = data.obfuscated || data.token || JSON.stringify(data);
        }

        obf.textContent = finalUrl;
        obf.title = finalUrl;
        out.style.display = 'block';
        showInfo("Success — copy or open the obfuscated URL.", "success");

      } catch (err) {
        console.error(err);
        showInfo("Network/connection error: " + String(err), "error");
      } finally {
        setLoading(false);
      }
    });

    btnCopy.addEventListener('click', async () => {
      try {
        const text = obf.textContent;
        if (!text) return;
        await navigator.clipboard.writeText(text);
        showInfo("Copied to clipboard.", "success");
      } catch (e) {
        try {
          const range = document.createRange();
          range.selectNodeContents(obf);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          showInfo("Copy failed via clipboard API. Text selected — press Ctrl/Cmd+C.", "error");
        } catch (_) {
          showInfo("Copy failed: " + String(e), "error");
        }
      }
    });

    btnOpen.addEventListener('click', () => {
      const url = obf.textContent;
      if (!url) return;
      try {
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (e) {
        showInfo("Unable to open link: " + String(e), "error");
      }
    });

    // Accessibility: Enter key on inputs triggers generation
    [elUrl, elExpiry].forEach(el => {
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          btnGen.click();
        }
      });
    });
  </script>
</body>
</html>
